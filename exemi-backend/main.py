from typing import Union

from fastapi import FastAPI, HTTPException
from fastapi.security import OAuth2PasswordBearer
from fastapi.middleware.cors import CORSMiddleware

import requests

app = FastAPI()

origins = [
    "http://localhost:5173",
    "https://localhost:5173"
]

app.add_middleware(
    CORSMiddleware,
    allow_origins=origins,
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)

@app.get("/")
def read_root():
    return {"Hello": "World"}

@app.post("/is_token_valid/")
async def is_token_valid(provider : str, access_token : str) -> bool:
    """
    Verify whether a manual Canvas API token generated by a user is valid for a given Canvas installation.

    Args:
        provider (str): The name of the institution which has installed Canvas.
        access_token (str): A manually generated Canvas access token.

    Returns:
        exists (bool): Returns true if the user's access token is valid for the given Canvas provider.
    """
    response = requests.get(f"https://{provider}.instructure.com/api/v1/users/self", params={
        "access_token":access_token,
    })
    return response.status_code == 200

@app.post("/login/")
async def login(credentials:dict):

    provider = credentials["provider"]
    access_token = credentials["token"]

    legit = await is_token_valid(provider, access_token)

    print(legit)

    if not legit:
        return HTTPException(status_code = 401, detail=f"Canvas Access Token for {provider} installation is invalid.")
    
    return "Authorised"
